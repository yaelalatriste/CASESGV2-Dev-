@model CedulasEvaluacion.Entities.MFinancieros.ModelsFinancieros;
@{
    ViewData["Title"] = "Detalle de Cédulas y Oficios en el Servicio de \"" + Model.dashboard.ElementAt(0).Servicio + "\"";
    var estatus = new List<string>();
    var meses = new List<string>();
    var anio = 2023;

    @foreach (var dt in @Model.dashboard)
    {
        estatus.Add(dt.Estatus);
        meses.Add(dt.Mes);
    }

    HashSet<string> quitaEstatus = new HashSet<string>(estatus);
    List<string> lestatus = quitaEstatus.ToList();

    HashSet<string> quitaMeses = new HashSet<string>(meses);
    List<string> lmeses = quitaMeses.ToList();

    var j = 0;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <a href="/financieros/index" type='button' class="btn btn-sm btn-warning ml-2 float-right" data-toggle="tooltip" title="Regresar al Listado de Servicios" data-placement="top"><i class="fal fa-arrow-left"></i></a>
            <a href="#" class="btn btn-sm btn-primary float-right" id="newOficio" data-toggle="tooltip" title='Generar un nuevo "Oficio"'><i class="fas fa-plus"></i></a>
        </div>
    </div>
    <div class="row mt-4 mb-4">
        <div class="col-lg-12">
            <table class="table dataTables" id="tableOficios" width="100%">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Servicio</th>
                        <th>Año</th>
                        <th>Numero de Oficio</th>
                        <th>Estatus</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var of in Model.oficio)
                    {
                        j++;
                        <tr>
                            <td>@j</td>
                            <td>@of.Servicio</td>
                            <td>@of.Anio</td>
                            <td>@of.NumeroOficio/@of.Anio</td>
                            <td>@of.Estatus</td>
                            <td>
                                @if (@of.Estatus.Equals("En Proceso"))
                                {
                                    <a href="/financieros/oficio/@Model.oficio[0].ServicioId/@of.Id" data-toggle="tooltip" title='Editar el Oficio "@of.Anio/@of.NumeroOficio"'>
                                        <i class="fas fa-pencil text-primary mr-2"></i>
                                    </a>
                                }
                                @if (@of.Estatus.Equals("Enviado a DGPPT") || @of.Estatus.Equals("Pagada"))
                                {
                                    <a href="/financieros/revisar/@Model.oficio[0].ServicioId/@of.Id" data-toggle="tooltip" title='Ver detalles del Oficio "@of.Anio/@of.NumeroOficio"'>
                                        <i class="fas fa-eye text-primary mr-2"></i>
                                    </a>
                                }
                                @if (@of.Estatus.Equals("Enviado a DGPPT"))
                                {
                                    <a class="cancelarOficio" href="#" data-id="@of.Id" data-oficio="@of.NumeroOficio" data-anio="@of.Anio" data-toggle="tooltip" title='Cancelar el Oficio "@of.Anio/@of.NumeroOficio"'>
                                        <i class="fa-solid fa-ban text-danger mr-2"></i>
                                    </a>
                                }

                                @if (@of.Estatus.Equals("Enviado a DGPPT"))
                                {
                                    <a class="pagarOficio" href="#" data-id="@of.Id" data-toggle="tooltip" title='Pagar el Oficio "@of.Anio/@of.NumeroOficio"'>
                                        <i class="fa-duotone fa-money-bill-1-wave text-success"></i>
                                    </a>
                                }
                                @if (@of.Estatus.Equals("Cancelado"))
                                {
                                    <p class="font-weight-bold text-danger">Oficio Cancelado</p>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="row col-lg-12 mt-3">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-gray text-white">
                    <h4>Cédulas en Proceso de Operación</h4>
                </div>
                <div class="card-body">
                    <div class="row col-lg-12">
                        <table class="table table-striped table-bordered table-hover dataTables" id="tbl_detalles">
                            <thead>
                                <tr>
                                    <th></th>
                                    @foreach (var est in lestatus)
                                    {
                                        if (est.Equals("En Proceso") || est.Equals("Enviado a DAS") || est.Equals("Autorizada") || est.Equals("Rechazada")
                                            || est.Equals("Trámite Rechazado"))
                                        {
                                            <th>@est</th>
                                        }
                                    }
                                </tr>
                            </thead>
                            <tbody id="tbl_op"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row col-lg-12">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-gray text-white">
                    <h4>Cédulas en Proceso de CAE</h4>
                </div>
                <div class="card-body">
                    <div class="row col-lg-12">
                        <table class="table table-striped table-bordered table-hover dataTables" id="tbl_detalles">
                            <thead>
                                <tr>
                                    <th></th>
                                    @foreach (var est in lestatus)
                                    {
                                        if (est.Equals("Revisión CAE") || est.Equals("Autorizado CAE"))
                                        {
                                            <th>@est</th>
                                        }
                                    }
                                </tr>
                            </thead>
                            <tbody id="tbl_cae"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-gray text-white">
                    <h4>Cédulas en Proceso de Financieros</h4>
                </div>
                <div class="card-body">
                    <div class="row col-lg-12">
                        <table class="table table-striped table-bordered table-hover dataTables" id="tbl_detalles">
                            <thead>
                                <tr>
                                    <th></th>
                                    @foreach (var est in lestatus)
                                    {
                                        if (est.Equals("En Trámite") || est.Equals("Trámite de Pago") || est.Equals("Enviada a DGPPT") || est.Equals("Pagado"))
                                        {
                                            <th>@est</th>
                                        }
                                    }
                                </tr>
                            </thead>
                            <tbody id="tbl_financieros"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@*Modal para Capturar Oficios*@
<div class="modal fade" id="modal-oficio">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Nuevo Oficio</h4>
                <button type="button" class="close close-incidencias text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="form-row col-md-3" id="divCategoria">
                        <label for="">Servicios:</label>
                        <select class="form-control" id="selectServicio"></select>
                        <div class="col-sm-12" id="error_servicio">
                            <small id="dateHelp" class="text-danger">
                                Por favor capture el servicio para el oficio
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-3" id="divCategoria">
                        <label for="Anio">Año del Oficio: </label>
                        <select id="selectAnio" class="form-control">
                            <option value="">Seleccione una opción</option>
                            @for (var i = 2021; i < anio; i++)
                            {
                                <option value="@i">@i</option>
                            }
                        </select>
                        <div class="col-sm-12" id="error_anio">
                            <small id="dateHelp" class="text-danger">
                                Por favor capture el año del oficio
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-md-3" id="divCategoria">
                        <label for="">Número de Oficio:</label>
                        <input class="form-control" id="numeroOficio" type="number" required />
                        <div class="col-sm-12" id="error_numero">
                            <small id="dateHelp" class="text-danger">
                                Por favor capture el número del oficio
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="crearOficio">Crear Oficio</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin del Modal para Capturar Oficios*@

@section Scripts{
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
            var meses = @Html.Raw(Json.Serialize(lmeses));
            var dashboard = @Html.Raw(Json.Serialize(@Model.dashboard));
            var oficios = @Html.Raw(Json.Serialize(@Model.oficio));
            var tbody = "";
            var tbodyC = "";
            var tbodyF = "";
            var model = @Html.Raw(Json.Serialize(@Model));

            console.log(model);

            $("#tableOficios").DataTable({
                paging: true,
                bLengthChange: false,
                pageLength: 10,
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.10.19/i18n/Spanish.json"
                },
            });

            /*Flujo de Oficio*/
                $(".cancelarOficio").click(function () {
                    Swal.fire({
                        'icon': 'warning',
                        'title': 'Trámite de Oficio',
                        'html': '¿Está seguro que desea <b>cancelar el oficio con el número: ' + $(this).data('oficio') + '/' + $(this).data('anio') + '?',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, cancelar',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(confirm => {
                        if (confirm.isConfirmed) {
                            axios.get("/financieros/cancela/oficio/" + model.oficio[0].servicioId + '/' + $(this).data('id')).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        'icon': 'success',
                                        'title': 'Oficios para Trámite de Pago',
                                        'html': 'Se canceló el oficio correctamente.'
                                    }).then(function () {
                                        window.location.reload();
                                    });
                                }
                            });
                        }
                    });
                });

                $(".pagarOficio").click(function () {
                    Swal.fire({
                        'icon': 'warning',
                        'title': 'Trámite de Oficio',
                        'html': '¿Está seguro que desea <b>pagar el oficio con el número: ' + $(this).data('oficio') + '/' + $(this).data('anio')+'?',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, pagar',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(confirm => {
                        if (confirm.isConfirmed) {
                            axios.get("/financieros/pagar/oficio/" + model.oficio[0].servicioId + '/' + $(this).data('id')).then(response => {
                                if (response.status == 200) {
                                    Swal.fire({
                                        'icon': 'success',
                                        'title': 'Oficios para Trámite de Pago',
                                        'html': 'Se pagó el oficio correctamente.'
                                    }).then(function () {
                                        window.location.reload();
                                    });
                                }
                            });
                        }
                    });
                });
            /*Fin Flujo de Oficio*/

            /*Errores de Captura de Oficio*/
            $('#error_servicio').css('display', 'none');
            $('#error_anio').css('display', 'none');
            $('#error_numero').css('display', 'none');
            /*Fin Errores de Captura de Oficio*/

            /*Llenado de la Tabla de Porcentajes*/
                axios.get('/financieros/generaTabla/' + dashboard[0].servicio+'/'+'Operacion').then(table => {
                    table = table.data;
                    for (let i = 0; i < meses.length; i++) {
                        tbody += "<tr><td class='font-weight-bold'>" + meses[i] + "</td>";
                        for (let c = 0; c < table[i].length; c++) {
                            tbody += table[i][c];
                        }
                        tbody += "</tr>";
                    }
                    $("#tbl_op").html(tbody);
                });
            /*Llenado de la Tabla de Porcentajes*/

            /*Llenado de la Tabla de Porcentajes*/
                axios.get('/financieros/generaTabla/' + dashboard[0].servicio + '/' + 'CAE').then(table => {
                    table = table.data;
                    for (let i = 0; i < meses.length; i++) {
                        tbodyC += "<tr><td class='font-weight-bold'>" + meses[i] + "</td>";
                        for (let c = 0; c < table[i].length; c++) {
                            tbodyC += table[i][c];
                        }
                        tbodyC += "</tr>";
                    }
                    $("#tbl_cae").html(tbodyC);
                });
            /*Llenado de la Tabla de Porcentajes*/

            /*Llenado de la Tabla de Porcentajes*/
                axios.get('/financieros/generaTabla/' + dashboard[0].servicio + '/' + 'Financieros').then(table => {
                    table = table.data;
                    for (let i = 0; i < meses.length; i++) {
                        tbodyF += "<tr><td class='font-weight-bold'>" + meses[i] + "</td>";
                        for (let c = 0; c < table[i].length; c++) {
                        tbodyF += table[i][c];
                        }
                        tbodyF += "</tr>";
                    }
                    $("#tbl_financieros").html(tbodyF);
                });
            /*Llenado de la Tabla de Porcentajes*/

            $("#newOficio").click(function () {
                var servicios = '<option value="">Seleccione un Servicio</option>';
                /*Llenado de la Lista de Servicios*/
                axios.get('/catalogo/servicios').then(options => {
                    options = options.data;
                    for (let i = 0; i < options.length; i++) {
                        servicios += '<option value="'+options[i].id+'">'+options[i].nombre+'</option>';
                    }
                    $("#selectServicio").html(servicios);
                    $("#selectServicio").val(model.dashboard[0].servicioId).change();
                    $("#selectServicio").prop('disabled',true);
                });
                /*Llenado de la Lista de Servicios*/
                $("#modal-oficio").modal('show');
            });

            function validaCamposOficio() {
                if ($("#selectServicio").val() != "" && $("#selectAnio").val() != "" && $("#numeroOficio").val() != "") {
                    return true;
                }

                if ($('#selectServicio').val() == "") {
                    $('#selectServicio').addClass('is-invalid');
                    $('#error_servicio').css('display', 'block');
                }

                if ($('#selectAnio').val() == "") {
                    $('#selectAnio').addClass('is-invalid');
                    $('#error_anio').css('display', 'block');
                }

                if ($('#numeroOficio').val() == "") {
                    $('#numeroOficio').addClass('is-invalid');
                    $('#error_numero').css('display', 'block');
                }
                return false;
            }

            $('#selectServicio').change(function () {
                if ($(this).val() != "") {
                    $('#selectServicio').removeClass('is-invalid');
                    $('#error_servicio').css('display', 'none');
                }
            });

            $('#selectAnio').change(function () {
                if ($(this).val() != "") {
                    $('#selectAnio').removeClass('is-invalid');
                    $('#selectAnio').addClass('is-valid');
                    $('#error_anio').css('display', 'none');
                }
            });

            $('#numeroOficio').change(function () {
                if ($(this).val() != "") {
                    $('#numeroOficio').removeClass('is-invalid');
                    $('#numeroOficio').addClass('is-valid');
                    $('#error_numero').css('display', 'none');
                }
            });

            $("#crearOficio").click(function () {
                var servicio = $("#selectServicio").val();
                var anio = $("#selectAnio").val();
                var oficio = $("#numeroOficio").val();

                if (validaCamposOficio()) {
                    axios.post('/financieros/inserta/oficio', { ServicioId: parseInt(servicio), Anio: parseInt(anio), NumeroOficio: parseInt(oficio)}).then(response => {
                        if (response.status == 200) {
                            Swal.fire({
                                'icon': 'success',
                                'title': 'Oficios para Trámite de Pago',
                                'html': 'Se generó el oficio correctamente.'
                            }).then(function () {
                                window.location.href = '/financieros/oficio/' + dashboard[0].servicioId+'/'+response.data;
                            });
                        }
                    });
                }
            });

        });
    </script>
}