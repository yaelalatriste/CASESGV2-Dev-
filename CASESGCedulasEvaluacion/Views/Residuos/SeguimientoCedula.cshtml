@model CedulasEvaluacion.Entities.MResiduos.Residuos;
@{
    ViewData["Title"] = "Seguimiento a la Cédula del Servicio de RPBI con Folio: " + Model.Folio;
}

<div class="row col-lg-12">
    <div class="col-lg-12">
        <a href="/residuos/index" type='button' class='btn-sm btn-warning float-right mr-2 mb-3 btn_back'><i class="fal fa-arrow-left"></i></a>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <ul class="nav nav-tabs h6" id="myTab" role="tablist">
            @{int i = 0;}
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#informacion_general" role="tab" aria-controls="home" aria-selected="true">Información General</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#entregables_cedula" role="tab" aria-controls="contact" aria-selected="false">Entregables</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#historial_cedula" role="tab" aria-controls="contact" aria-selected="false">Historial de Cambios</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#historial_entregables" role="tab" aria-controls="contact" aria-selected="false">Historial de Entregables</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            @{ bool autoriza = true; }
            <div class="tab-pane fade show active" id="informacion_general" role="tabpanel" aria-labelledby="home-tab">
                <div class="row justify-content-center align-items-center mt-4">
                    <div class="col-lg-12 h3 ml-4">
                        Información General
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12 mt-3">
                        <div class="card bg-light d-flex flex-fill">
                            <div class="card-header border-bottom-0">
                                <h2 class="lead"><b>Inmueble Evaluado: </b> @Model.inmuebles.Nombre</h2>
                            </div>
                            <div class="card-body pt-0">
                                <div class="row">
                                    <div class="col-7">
                                        <h2 class="lead">
                                            <strong>
                                                Factura Capturadas:
                                            </strong>
                                            <a href="#" id="btn_facturas" class='btn btn-sm btn-facturas ml-2 mb-1' data-toggle="tooltip" title="Ver Facturas" data-placement="top">
                                                <i class="fal fa-file-invoice"></i>
                                            </a>
                                        </h2>
                                        <p class="text-sm">Evaluación correspondiente al mes <b>@Model.Mes</b> del año <b>@Model.Anio</b></p>
                                        <ul class="ml-4 mb-0 fa-ul">
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-dollar-sign"></i></span> <b>Facturación Total: </b>: @String.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", Model.TotalMontoFactura)</li>
                                            @if (Model.RespuestasEncuesta[4].Respuesta == true)
                                            {
                                                <li class="small mt-3"><span class="fa-li"><i class="fad fa-user"></i></span> <b>Inasistencias: </b> @Model.RespuestasEncuesta[4].Detalles</li>
                                            }
                                            else
                                            {
                                                <li class="small mt-3"><span class="fa-li"><i class="fad fa-user"></i></span> <b>Sin Inasistencias </b></li>
                                            }
                                            </li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fad fa-star"></i></span> <b>Calificación: </b> @Model.Calificacion</li>
                                            <li class="small mt-3"><span class="fa-li"><i class="fas fa-lg fa-user"></i></span> <b>Elaboró: </b> @Model.usuarios.nombre_emp @Model.usuarios.paterno_emp @Model.usuarios.materno_emp</li>
                                            <li class="small mt-3">
                                                <span class="fa-li"><i class="fas fa-lg fa-envelope mb-1"></i></span>
                                                <strong>Correo:</strong>
                                                @if (@Model.usuarios.correo_electronico.Equals("") || @Model.usuarios.correo_electronico.Equals(null))
                                                {
                                                    <strong class="text-danger">@String.Format("Sin correo")</strong>
                                                }
                                                else
                                                {
                                                    @Model.usuarios.correo_electronico
                                                }
                                                <a href="#" id="btn_correo" class='btn-xs btn-primary ml-2' data-toggle="tooltip" title="Actualizar Correo Electrónico" data-placement="top">
                                                    <i class="fal fa-edit"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-5">
                                        @if (@Model.Estatus.Equals("Revisión"))
                                        {
                                            <h5 class="text-primary lblEstatus"><strong>Estatus: </strong> @Model.Estatus</h5>
                                        }
                                        else if (@Model.Estatus.Equals("Autorizada") || @Model.Estatus.Equals("Trámite de Pago"))
                                        {
                                            <h5 class="text-success lblEstatus"><strong>Estatus: </strong> @Model.Estatus </h5>
                                        }
                                        else if (@Model.Estatus.Equals("Rechazada") || @Model.Estatus.Equals("Trámite Rechazado"))
                                        {
                                            <h5 class="text-danger lblEstatus"><strong>Estatus: </strong> @Model.Estatus </h5>
                                        }
                                        else
                                        {
                                            <h5 class="text-info lblEstatus"><strong>Estatus: </strong> @Model.Estatus </h5>
                                        }
                                        <div class="col-lg-4" style="margin-top: -18px;">
                                            <div class="small-box bg-warning">
                                                <div class="icon">
                                                    <i class="fas fa-check-circle text-success"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @if (@Model.Estatus.Equals("Autorizada") || Model.Estatus.Equals("Trámite Rechazado"))
                            {
                                <div class="card-footer">
                                    <div class="text-right" id="divAutoriza"></div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="entregables_cedula" role="tabpanel" aria-labelledby="contact-tab">
                <div class="col-lg-12 h3 mt-4">
                    Entregables Periódicos
                </div>
                <div class="row col-lg-12">
                    <div class="col-lg-8">
                        <p class="h6">El usuario adjunto los siguientes entregables.</p>
                    </div>
                </div>
                <div class="row col-lg-12 mt-1 h6">
                    <div class="col-lg-12">
                        <div class="col-lg-12 mb-3" id="divAdjuntar"></div>
                        <h6 class="mt-4"><strong>Entregables Adjuntos</strong></h6>
                        <table class="table" id="tableEntregables">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nombre</th>
                                    <th>Fecha de Creación</th>
                                    <th>Ver</th>
                                    <th class="text-center">Estatus</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ string tipo = ""; }
                                @foreach (var entre in @Model.rEntregables)
                                {
                                    <tr>
                                        @if (entre.Tipo.Equals("ActaER"))
                                        {
                                            tipo = "Acta Entrega - Recepción";
                                            <td>@Html.DisplayName(tipo)</td>
                                        }
                                        else if (entre.Tipo.Equals("Factura"))
                                        {
                                            tipo = "Factura";
                                            <td>@Html.DisplayName(tipo)</td>
                                        }
                                        else if (entre.Tipo.Equals("SAT"))
                                        {
                                            tipo = "Validación del SAT";
                                            <td>@Html.DisplayName(tipo)</td>
                                        }
                                        else if (entre.Tipo.Equals("NotaCredito"))
                                        {
                                            tipo = "Nota de Crédito";
                                            <td>@Html.DisplayName(tipo)</td>
                                        }
                                        else if (entre.Tipo.Equals("Manifiesto"))
                                        {
                                            tipo = "Manifiesto de Entrega";
                                            <td>@Html.DisplayName(tipo)</td>
                                        }
                                        else if (entre.Tipo.Equals("Cedula_Firmada"))
                                        {
                                            tipo = "Cedula Firmada";
                                            <td>@Html.DisplayName(tipo)</td>
                                        }
                                        else
                                        {
                                            tipo = @entre.Tipo;
                                            <td>@entre.Tipo</td>
                                        }
                                        <td>@entre.NombreArchivo</td>
                                        <td>@entre.FechaCreacion.ToString("dd-MM-yyyy")</td>
                                        <td>
                                            <a href='#' class='text-center mr-2 view_file' data-id="@entre.Id" data-file="@entre.NombreArchivo" data-tipo="@entre.Tipo">
                                                <i class='fas fa-eye text-success'></i>
                                            </a>
                                        </td>
                                        @if (@entre.Estatus.Equals(""))
                                        {
                                            @if((@User.Claims.ElementAt(2).Value).Contains("Administrador") || (@User.Claims.ElementAt(2).Value).Contains("Financieros")){ 
                                                autoriza = false;
                                                <td class="text-center">
                                                    <a href="#" class='btn-xs btn-success mr-2 success_entregable' data-id="@entre.Id" data-tipo="@tipo"
                                                       data-toggle="tooltip" title="Autorizar @tipo" data-placement="top">
                                                        <i class="fal fa-check"></i>
                                                    </a>
                                                    <a href="#" class='btn-sm btn-danger mr-2 failed_entregable' data-id="@entre.Id" data-tipo="@tipo"
                                                       data-toggle="tooltip" title="Rechazar @tipo" data-placement="top">
                                                        <i class="far fa-times"></i>
                                                    </a>
                                                </td>
                                            }
                                        }
                                        else if (@entre.Estatus.Equals(""))
                                        {
                                            autoriza = false;
                                            <td class="text-center text-info font-weight-bold">En Revision</td>
                                        }
                                        else if (@entre.Estatus.Equals("Rechazado"))
                                        {
                                            autoriza = false;
                                            <td class="row col-lg-12 justify-content-center">
                                                <div class="form-row" data-tipo="@entre.Tipo">
                                                    <div class="icon mr-2 text-danger font-weight-bold" data-toggle="tooltip" title="Entregable Rechazado">
                                                        <i class="fas fa-times-circle"></i> Rechazado
                                                    </div>
                                                    <a href='#' class="text-center mr-2 update_files" data-id="@entre.Id" data-coments="@entre.Comentarios"
                                                       data-file="@entre.NombreArchivo" data-tipo="@entre.Tipo" data-toggle="tooltip" title="Actualizar @entre.Tipo"
                                                       data-placement="top">
                                                        <i class='fas fa-edit text-primary'></i>
                                                    </a>
                                                </div>
                                            </td>
                                        }
                                        else if (@entre.Estatus.Equals("Autorizado"))
                                        {
                                            <td class="text-center">
                                                <div class="icon text-success font-weight-bold" data-toggle="tooltip" title="Entregable Autorizado">
                                                    <i class="fas fa-check-circle"></i> Autorizado
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="historial_cedula" role="tabpanel" aria-labelledby="contact-tab">
                <div class="row justify-content-center align-items-center mt-4">
                    <div class="col-lg-12 h3 ml-4">
                        Seguimiento de la Cédula
                    </div>
                    <div class="row col-lg-12">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Usuario</th>
                                    <th>Comentarios</th>
                                    <th>Estatus</th>
                                    <th>Fecha de Actualización</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var hist in @Model.historialCedulas)
                                {
                                    <tr>
                                        <td>@hist.Servicio</td>
                                        <td>@hist.usuarios.nombre_emp @hist.usuarios.paterno_emp @hist.usuarios.materno_emp</td>
                                        <td>@hist.Comentarios</td>
                                        <td>@hist.Estatus</td>
                                        <td>@hist.FechaCreacion</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="historial_entregables" role="tabpanel" aria-labelledby="contact-tab">
                <div class="row justify-content-center align-items-center mt-4">
                    <div class="col-lg-12 h3 ml-4">
                        Seguimiento de los Entregables
                    </div>
                    <div class="row col-lg-12">
                        <table class="table mt-2">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Entregable</th>
                                    <th>Usuario</th>
                                    <th>Comentarios</th>
                                    <th>Estatus</th>
                                    <th>Fecha de Actualización</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var hist in @Model.historialEntregables)
                                {
                                    <tr>
                                        <td>@hist.Servicio</td>
                                        <td>@hist.Tipo</td>
                                        <td>@hist.usuarios.nombre_emp @hist.usuarios.paterno_emp @hist.usuarios.materno_emp</td>
                                        <td>@hist.Comentarios</td>
                                        <td>@hist.Estatus</td>
                                        <td>@hist.FechaCreacion</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Modal para ver las facturas de la cedula *@
<div class="modal fade" id="modal-ver-facturas">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Factura(s) Capturadas</h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12 mt-3">
                        <table class="table table-responsive" id="listado_facturas">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Empresa</th>
                                    <th>Folio Fiscal</th>
                                    <th>Numero de la Factura</th>
                                    <th>Subtotal de la Factura</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="listaFacturas"></tbody>
                        </table>
                    </div>
                    <div class="row col-lg-12 text-center">
                        <div class="col-lg-12 objectPdf">

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@* FIN del Modal para ver las facturas de la cedula *@

@* Modal para ver los conceptos de las facturas de la cedula *@
<div class="modal fade" id="modal-ver-conceptos">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="factura_serie"></h4>
                <button type="button" class="close close_conceptos text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class=" row col-lg-12" id="detalle_conceptos"></div>
            </div>
        </div>
    </div>
    <!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
@* Fin de Modal para ver los conceptos de las facturas de la cedula *@

@* Modal para la captura de Adjuntos *@
<div class="modal fade" id="modal_evidencias">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white">Adjuntar/Modificar Entregables</h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <input type="hidden" id="file_id" />
                    <div class="form-group col-lg-4">
                        <label for="tipoIncidencia">Tipo de Entregable:</label>
                        <select class="form-control" id="tipo_entregable"></select>
                        <div class="col-sm-12" id="error_tipoEntre">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione el tipo de entregable
                            </small>
                        </div>
                    </div>
                    <div class="form-group col-lg-6">
                        <label for="elegirArchivo">Seleccionar Archivo: </label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="customFile" accept=".pdf">
                            <label class="custom-file-label" for="customFile">Seleccionar Archivo</label>
                        </div>
                        <div class="col-sm-12" id="error_customFile">
                            <small id="dateHelp" class="text-danger">
                                Por favor seleccione él archivo correspondiente
                            </small>
                        </div>
                    </div>
                    <div class="form-row col-lg-12 mt-2" id="comentariosEntregable">
                        <div class="form-group mt-2 col-md-12">
                            <label for="fechaCierre">Comentarios:</label><br>
                            <textarea id="comentarios_entregable" class="form-control float-left"></textarea>
                            <div class="col-sm-12" id="error_comentariosEntre">
                                <small id="comentariosHelp" class="text-danger">
                                    Por favor capture los comentarios correspondientes
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="adjuntarArchivo">Adjuntar Entregable</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para la captura de Incidencias *@

@* Modal para la ver Adjuntos *@
<div class="modal fade" id="show_pdf">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-joke">
                <h4 class="modal-title text-white" id="titlePDF"></h4>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <tr>
                        <td><strong>Folio: </strong> @Model.Folio</td>
                        <td><strong>Año: </strong>@Model.Anio</td>
                        <td><strong>Mes: </strong>@Model.Mes</td>
                        <td><strong>Inmueble: </strong>@Model.inmuebles.Nombre</td>
                        <td><strong>Estatus: </strong>@Model.Estatus </td>
                    </tr>
                </table>
                <div class="row" id="objectPdf">
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@*Fin Modal para ver Adjuntos*@


<style>
    #view_pdf {
        width: 100%;
        height: 500px;
    }
</style>

@section Scripts{
    <script>
        $(function () {
            var model = @Html.Raw(Json.Serialize(@Model));
            var autoriza = @Html.Raw(Json.Serialize(autoriza));
            $('[data-toggle="tooltip"]').tooltip();

            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("href") // activated tab
                localStorage.setItem('activeTab', target);
            });

            if (localStorage.getItem('activeTab')) {
                var idTab = localStorage.getItem('activeTab').replace("#", "");
                $('a[href="#informacion_general"]').removeClass('active');
                $('a[href="' + localStorage.getItem('activeTab') + '"]').addClass('active');
                $("#informacion_general").removeClass("show active");
                $("#" + idTab).addClass("show active");
            } else {
                $('#myTab li:first').addClass('active');
            }

            if (model.estatus == 'Autorizada') {
                $("#divAdjuntar").html("<a href = '#' type = 'button' class='btn-sm btn-success mr-2 float-right btn_addFile' data - toggle='tooltip' title = 'Adjuntar Entregable'> <i class='fas fa-plus'></i></a>");
            }


            /*Adjuntar Archivos*/
            $('#error_tipoEntre').css('display', 'none');
            $('#error_customFile').css('display', 'none');
            $('#error_comentariosEntre').css('display', 'none');

            /*Inserta Boton Autoriza*/
                if (autoriza == true) {
                    $("#divAutoriza").html('<button href="" class="btn btn-success float-right mr-3 tramitar_cedula"><i class="fas fa-check mr-2"></i>Envíar a Trámite</button>');
                }
                else if (autoriza == false)
                {
                    var files = ["Memorandum", "Cedula_Firmada", "ActaER", "Factura", "Manifiesto", "SAT"];
                    var tramitar = new Array();
                    axios.get("/residuos/getListadoEntregables/" + model.id).then(response => {
                        response = response.data;
                        let rechazado = false;
                        for (var i = 0; i < files.length; i++) {
                            for (var j = 0; j < response.length; j++) {
                                if (files[i] == response[j].tipo && response[j].estatus == 'Rechazado') {
                                    rechazado = true;
                                    break;
                                }
                                tramitar.push(response[j].tipo);
                            }
                            if (rechazado == true) {
                                break;
                            }
                        }
                        if (rechazado == false && tramitar.includes("Memorandum") && tramitar.includes("Cedula_Firmada")){
                            $("#divAutoriza").html('<button href="" class="btn btn-success float-right mr-3 tramitar_cedula"><i class="fas fa-check mr-2"></i>Envíar a Trámite</button>');
                        }
                     });
                }

            /*Tramitar Cedula*/
            $(document).on('click', '.tramitar_cedula', function () {
                if (model.usuarios.correo_electronico == "") {
                    Swal.fire({
                        'icon': 'error',
                        'title': 'Servicio de RPBI',
                        'text': 'No se puede "Aceptar" la cédula ya que aún no se registra un correo electrónico para notificarle al usuario.'
                    });
                } else {
                    Swal.fire({
                        'icon': 'warning',
                        'title': 'Servicio de RPBI',
                        'html': '¿Estas seguro de que deseas <b>Aceptar la cédula con el folio: ' + model.folio + ' ?',
                        'confirmButtonColor': '#3085d6',
                        'cancelButtonColor': '#d33',
                        'confirmButtonText': 'Si, aceptar cédula',
                        'cancelButtonText': 'Cancelar',
                        'showCancelButton': true
                    }).then(confirm => {
                        if (confirm.isConfirmed) {
                            Swal.fire({
                                icon: 'info',
                                'title': 'Servicio de RPBI',
                                text: 'Por favor captura los comentarios para el trámite de la cédula.',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                cancelButtonText: 'Cancelar',
                                confirmButtonText: 'Tramitar',
                                input: 'text',
                                inputPlaceholder: 'Escribe los comentarios correspondientes'
                            }).then(send => {
                                if (send.value.length > 0) {
                                    axios.post('/residuos/historialResiduos', {
                                        CedulaId: model.id, UsuarioId: model.usuarioId,
                                        Estatus: "En Trámite", Comentarios: send.value
                                    }).then(hist => {
                                        if (hist.status == 200) {
                                            axios.post('/residuos/aprovRechCed', { Id: model.id, Estatus: "En Trámite" }).then(response => {
                                                if (response.status == 200) {
                                                    Swal.fire({
                                                        'icon': 'success',
                                                        'title': 'Servicio de RPBI',
                                                        'text': 'Se envío a trámite la cédula de forma correcta.'
                                                    }).then(function () {
                                                        window.location.reload();
                                                    });
                                                }
                                            });
                                        }
                                    }).catch(er => {
                                        Swal.fire({
                                            'icon': 'error',
                                            'title': 'Servicio de RPBI',
                                            'text': 'Ocurrio un error al tramitar la cédula. Por favor comunicate a la ext. 2574.'
                                        });
                                    });
                                } else {
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio de RPBI',
                                        'text': 'Es necesario capturar los comentarios indicando el motivo por el cual se envía a trámite la cédula.'
                                    });
                                }
                            });
                        }
                    });
                }
            });
            /*Fin de Tramitar Cedula*/

            /*Ver archivo en modal*/
            $(document).on('click', '.view_file', function () {
                let nombre = $(this).data('file');
                let tipo = $(this).data('tipo');
                if (tipo == "Factura") {
                    modalFacturas(nombre);
                } else {
                    let data = "<object width='100%' height='400px' data='/cedLimpieza/verArchivo/" + model.folio + "/" + nombre + "'></object>";
                    $('#titlePDF').text("PDF - \"" + tipo + "\"");
                    $('#objectPdf').html(data);
                    $('#show_pdf').modal('show');
                }
            });
            /*FIN de ver archivo en modal*/

            /*Autorizar Entregable*/
            $(document).on('click', '.success_entregable', function () {
                var tipo = $(this).data('tipo');
                var id = $(this).data('id');

                Swal.fire({
                    'icon': 'warning',
                    'title': 'Servicio RPBI',
                    'html': '¿Estas seguro de que deseas autorizar el entregable <b>' + tipo+ '</b>?',
                    'confirmButtonColor': '#3085d6',
                    'cancelButtonColor': '#d33',
                    'confirmButtonText': 'Si, autorizar',
                    'cancelButtonText': 'Cancelar',
                    'showCancelButton': true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Servicio RPBI',
                            html: 'Por favor capture el motivo por el cual se autoriza el entregable <b>"'+tipo+'"</b>.',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Autorizar',
                            input: 'text',
                            inputValue: 'Se autoriza el entregable',
                        }).then(send => {
                            if (send.value.length > 0) {
                                axios.post('/residuos/entregables/historialEntregable', {
                                    CedulaId: model.id, UsuarioId: parseInt(@User.Claims.ElementAt(0).Value), Tipo: tipo,
                                    Estatus: "Autorizado", Comentarios: send.value
                                }).then(hist => {
                                    if (hist.status == 200) {
                                        axios.post('/residuos/entregables/autoRecha', { Id: id, Estatus: "Autorizado", CedulaResiduosId: parseInt(model.id) }).then(response => {
                                            if (response.status == 200) {
                                                Swal.fire({
                                                    'icon': 'success',
                                                    title: 'Servicio RPBI',
                                                    'text': 'Se autorizó el entregable correctamente'
                                                }).then(function () {
                                                    window.location.reload();
                                                });
                                            }
                                        });
                                    }
                                }).catch(er => {
                                    Swal.fire({
                                        'icon': 'error',
                                        title: 'Servicio RPBI',
                                        'text': 'Ocurrio un error al autorizar el entregable. Por favor comunicate a la ext. 2574.'
                                    });
                                });
                            } else {
                                Swal.fire({
                                    'icon': 'error',
                                    title: 'Servicio RPBI',
                                    'text': 'Es necesario capturar los comentarios indicando el motivo por el cual se rechaza la cédula.'
                                });
                            }
                        });
                    }
                });
            });
            /*Fin de Autorizar Cedula*/

            /*Rechazar Entregable*/
                $(document).on('click', '.failed_entregable', function () {
                var tipo = $(this).data('tipo');
                var id = $(this).data('id');

                Swal.fire({
                    'icon': 'warning',
                    'title': 'Servicio RPBI',
                    'html': '¿Estas seguro de que deseas rechazar el entregable <b>' + tipo+ '</b>?',
                    'confirmButtonColor': '#3085d6',
                    'cancelButtonColor': '#d33',
                    'confirmButtonText': 'Si, Rechazar',
                    'cancelButtonText': 'Cancelar',
                    'showCancelButton': true
                }).then(confirm => {
                    if (confirm.isConfirmed) {
                        Swal.fire({
                            icon: 'info',
                            'title': 'Servicio RPBI',
                            html: 'Por favor capture el motivo por el cual se rechaza el entregable <b>"'+tipo+'"</b>.',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Cancelar',
                            confirmButtonText: 'Rechazar',
                            input: 'text',
                            inputPlaceholder: 'Escribe los comentarios correspondientes'
                        }).then(send => {
                            if (send.value.length > 0) {
                                axios.post('/residuos/entregables/historialEntregable', {
                                    CedulaId: model.id, UsuarioId: parseInt(@User.Claims.ElementAt(0).Value), Tipo: tipo,
                                    Estatus: "Rechazado", Comentarios: send.value
                                }).then(hist => {
                                    if (hist.status == 200) {
                                        axios.post('/residuos/entregables/autoRecha', { Id: id, Estatus: "Rechazado", CedulaResiduosId: model.id }).then(response => {
                                            if (response.status == 200) {
                                                Swal.fire({
                                                    'icon': 'success',
                                                    'title': 'Servicio RPBI',
                                                    'text': 'Se rechazó el entregable correctamente'
                                                }).then(function () {
                                                    window.location.reload();
                                                });
                                            }
                                        });
                                    }
                                }).catch(er => {
                                    Swal.fire({
                                        'icon': 'error',
                                        'title': 'Servicio RPBI',
                                        'text': 'Ocurrio un error al rechazar el entregable. Por favor comunicate a la ext. 2574.'
                                    });
                                });
                            } else {
                                Swal.fire({
                                    'icon': 'error',
                                    'title': 'Servicio RPBI',
                                    'text': 'Es necesario capturar los comentarios indicando el motivo por el cual se rechaza la cédula.'
                                });
                            }
                        });
                    }
                });
            });
            /*Fin de Rechazar Entregable*/

             /*Ver Facturas*/
                function modalFacturas(nombre) {
                    axios.get('/limpieza/getFacturas/' + model.id+'/'+7).then(table => {
                        var facturas = table.data;
                        for (var i = 0; i < facturas.length; i++) {
                            table += "<tr>" +
                                "<td>" + (i + 1) + "</td>" +
                                "<td>" + facturas[i].emisor.nombre + "</td>" +
                                "<td>" + facturas[i].timbreFiscal.uuid + "</td>" +
                                "<td>" + (facturas[i].comprobante.serie + "" + facturas[i].comprobante.folio) + "</td>" +
                                "<td> $" + parseFloat(facturas[i].comprobante.subTotal).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + "</td>" +
                                "<td> $" + parseFloat(facturas[i].comprobante.total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + "</td>" +
                                "<td>" +
                                "<a class='update_factura' href='#' data-id='" + facturas[i].id + "'><i class='fad fa-pencil text-primary'></i></a>" +
                                "<a class='delete_factura' href='#' data-id='" + facturas[i].id + "'><i class='fad fa-times text-danger ml-2'></i></a>" +
                                "</td>" +
                                "</tr>";
                        }
                        let data = "<object width='100%' height='450px' data='/cedLimpieza/verArchivo/" + model.folio + "/" + nombre + "'></object>";
                        $('.objectPdf').html(data);
                        $("#listaFacturas").html(table);
                        if (facturas.length == 0) {
                            $("#listado_facturas").hide();
                        } else {
                            $("#listado_facturas").show();
                        }
                    });
                    $('#modal-ver-facturas').modal('show');
            }

                $("#btn_facturas").click(function () {
                    axios.get('/limpieza/getFacturas/' + model.id+'/'+7).then(table => {
                        var facturas = table.data;
                        console.log(facturas);
                        for (var i = 0; i < facturas.length; i++) {
                            table += "<tr>" +
                                "<td>" + (i + 1) + "</td>" +
                                "<td>" + facturas[i].emisor.nombre + "</td>" +
                                "<td>" + facturas[i].timbreFiscal.uuid + "</td>" +
                                "<td>" + (facturas[i].comprobante.serie + "" + facturas[i].comprobante.folio) + "</td>" +
                                "<td> $" + parseFloat(facturas[i].comprobante.subTotal).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + "</td>" +
                                "<td> $" + parseFloat(facturas[i].comprobante.total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + "</td>" +
                                "<td>" +
                                    "<a class='view_factura' href='#' data-id='" + i + "'><i class='far fa-list text-success'></i></a>" +
                                "</td>" +
                                "</tr>";
                        }
                            $("#listaFacturas").html(table);
                        if (facturas.length == 0) {
                            $("#listado_facturas").hide();
                        } else {
                            $("#listado_facturas").show();
                        }
                    });
                    $('#modal-ver-facturas').modal('show');
                });

                $(document).on('click', '.view_factura', function () {
                var id = $(this).data('id');
                var divTbl = "";
                $('#modal-ver-facturas').modal('hide');
                axios.get('/limpieza/getFacturas/' + model.id + '/' + 7).then(table => {
                    $("#factura_serie").text("Detalle de la Factura: " + table.data[id].comprobante.serie + table.data[id].comprobante.folio);
                    var conceptos = table.data[id].concepto;

                    for (var i = 0; i < conceptos.length; i++) {
                        divTbl += '<div class="row col-lg-12 mt-1">' +
                            '<table class="table table-borderless">' +
                            '<tr>' +
                            '<td colspan="4"><strong>Concepto: </strong>' + conceptos[i].descripcion + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '    <td data-toggle="tooltip" title="Número de elementos que prestaron el servicio en el mes" data-placement="top" id="concepto_cantidad"><strong>Cantidad: </strong>' + table.data[id].concepto[i].cantidad + '</td>' +
                            '    <td data-toggle="tooltip" title="Clave del Producto o Servicio Facturado" data-placement="top" id="concepto_cveProduc"><strong>Clave del Producto: </strong>' + table.data[id].concepto[i].claveProdServ + '</td>' +
                            '    <td data-toggle="tooltip" title="Clave de la Medida en Base al Servicio" data-placement="top" id="concepto_medida"><strong>Clave de Medida: </strong>' + table.data[id].concepto[i].claveUnidad + '</td>' +
                            '    <td data-toggle="tooltip" title="Unidad de Medida" data-placement="top" id="concepto_unidadMed"><strong>Unidad de Medida: </strong>' + table.data[id].concepto[i].unidad + '</td>' +
                            '    <td data-toggle="tooltip" title="Tipo de CFDI" data-placement="top" id="tipo_cfdi"><strong>Uso de CFDI: </strong>' + table.data[id].receptor.usoCFDI + '</td>' +
                            '    <td data-toggle="tooltip" title="Valor unitario por unidad" data-placement="top" id="concepto_unitario"><strong>Precio Unitario: </strong> $ ' + (table.data[id].concepto[i].valorUnitario).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '    <td data-toggle="tooltip" title="IVA del subtotal del 16%" data-placement="top" id="concepto_iva"><strong>IVA: </strong> $ ' + (table.data[id].traslado.importe).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + '</td>' +
                            '    <td data-toggle="tooltip" title="Importe total de la facturación" data-placement="top" id="concepto_total"><strong>Total: </strong> $ ' + (table.data[id].concepto[i].importe).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,') + '</td>' +
                            '    <td colspan="3"></td>' +
                            '</tr>' +
                            '</table>' +
                            '</div>';
                    }
                    $("#detalle_conceptos").html(divTbl);
                    $('#modal-ver-conceptos').modal('show');
                });
                });
            /*Fin de Ver Facturas*/

            /************************************ CARGA/EDICION ARCHIVOS ************************************/
                /*Modal para Adjuntar Archivos*/
                    $('.btn_addFile').click(function () {
                        var options = '<option value="">Seleccione un Entregable</option>';
                        axios.get("/residuos/getListadoEntregables/" + model.id).then(response => {
                            response = response.data;
                            console.log(response);
                            var memo = false;
                            var cedFirmada = false;
                            for (var i = 0; i < response.length;i++) {
                                if (response[i].estatus == "Rechazado" && response[i].tipo == "ActaER") {
                                    options += '<option value="ActaER">Acta Entrega - Recepción</option>'
                                } else if (response[i].estatus == "Rechazado" && response[i].tipo == "Factura") {
                                    options += '<option value="Factura">Factura</option>';
                                } else if (response[i].estatus == "Rechazado" && response[i].tipo == "SAT") {
                                    options += '<option value="SAT">Validación del SAT</option>';
                                } else if (response[i].estatus == "Rechazado" && response[i].tipo == "NotaCredito") {
                                    options += '<option value="NotaCredito">Nota de Crédito</option>';
                                } else if (response[i].estatus == "Rechazado" && response[i].tipo == "Memorandum") {
                                    options += '<option value="Memorandum">Memorandum</option>';
                                } else if (response[i].estatus == "Rechazado" && response[i].tipo == "Cedula_Firmada") {
                                    options += '<option value="Cedula_Firmada">Cédula Firmada</option>';
                                }

                                if (response[i].estatus == '' && response[i].tipo == "Memorandum") {
                                    memo = true;
                                }

                                if (response[i].estatus == '' && response[i].tipo == "Cedula_Firmada") {
                                    cedFirmada = true;
                                }
                            }

                            if (memo == false) {
                                options += '<option value="Memorandum">Memorandum</option>';
                            }
                            if (cedFirmada == false) {
                                options += '<option value="Cedula_Firmada">Cédula Firmada</option>';
                            }

                            $("#tipo_entregable").html(options);
                        });
                        $('#modal_evidencias').modal('show');
                    });
                /*FIN del modal para adjuntar archivos*/

                /*Adjunta Entregables*/
                    function validaCamposArchivo() {

                        if ($('#tipo_entregable').val() == "" && $('#customFile').val() == "") {
                            $('#tipo_entregable').addClass('is-invalid');
                            $('#error_tipoEntre').css('display', 'block');

                            $('#customFile').addClass('is-invalid');
                            $('#error_customFile').css('display', 'block');

                            return false;
                        }

                        if ($('#tipo_entregable').val() == "" ) {
                            $('#tipo_entregable').addClass('is-invalid');
                            $('#error_tipoEntre').css('display', 'block');

                            return false;
                        }

                        if ($('#customFile').val() == "") {

                            $('#customFile').addClass('is-invalid');
                            $('#error_customFile').css('display', 'block');

                            return false;
                        }

                        return true;
                    }
                    $("#customFile").on("change", function () {
                        var fileName = $(this).val().split("\\").pop();
                        var ext = fileName.split('.').pop();
                        if (ext == "pdf") {
                            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                        } else {
                            Swal.fire({
                                'icon': 'error',
                                'title': 'Formato Incorrecto',
                                'text': 'El archivo que intentas adjuntar no es válido. Favor de solo seleccionar archivos "PDF"'
                            });
                            $(".custom-file-label").text("Seleccionar Archivo");
                            document.getElementById('customFile').value = '';
                            if ($('#customFile').hasClass('is-valid')) {
                                $('#customFile').removeClass('is-valid');
                            }
                            $('#customFile').addClass('is-invalid');
                            $('#error_customFile').css('display', 'block');
                        }

                    });

                    $('#adjuntarArchivo').click(function () {
                        var formData = new FormData();
                        var folio = model.folio;
                        var file = document.getElementById('customFile').files[0];
                        var id = $('#file_id').val();
                        var tipo = $('#tipo_entregable').val();
                        var comentarios = $('#comentarios_entregable').val();

                        if (id.length > 0) {
                            id = parseInt(id);
                        } else {
                            id = 0;
                        }

                        formData.append("Id", id);
                        formData.append("CedulaResiduosId", model.id);
                        formData.append("Archivo", file);
                        formData.append("Folio", folio);
                        formData.append("Tipo", tipo);
                        formData.append("Comentarios", comentarios);

                        if (validaCamposArchivo()) {
                            if (id != 0) {
                                axios.post('/residuos/adjuntaEntregable', formData, {
                                    headers: { 'Content-Type': 'multipart/form-data' }

                                }).then(response => {
                                    $('#cerrar_modal_sua').trigger('click');
                                    /*Validamos la pregunta a la que se realizo el anexo de evidencia*/
                                    if (response.status == 200) {
                                        Swal.fire({
                                            'icon': "success",
                                            'title': 'Servicio de RPBI',
                                            'text': 'Se adjuntó el archivo de forma correcta.'
                                        }).then(function () {
                                            window.location.reload();
                                        });
                                        $('#customFile').removeClass('is-valid');
                                        $('#comentarios_entregable').removeClass('is-valid');
                                        $('#tipo_entregable').removeClass('is-valid');
                                    }
                                    axios.get("/residuos/getEntregables/" + model.id).then(success => {
                                        if (success.data == null || success.data == "") {
                                            $('#tEntregables').html(success.data);
                                        }
                                        $('#tEntregables').html(success.data);
                                    });
                                }).catch(error => {
                                    Swal.fire({
                                        'icon': "error",
                                        'title': 'Servicio de RPBI',
                                        'text': 'Se presento un error al intentar adjuntar el archivo.'
                                    });
                                });

                                document.getElementById('customFile').value = '';
                                $('#file_id').val("");
                                $(".custom-file-label").text("Seleccionar Archivo");
                                $('#tipo_entregable').val('');
                                $('#comentarios_entregable').val('');
                            } else {
                                axios.get('/residuos/buscaEntregable/' + model.id + '/' + tipo).then(exist => {
                                    console.log(exist);
                                    if (exist.data == 0) {
                                        axios.post('/residuos/adjuntaEntregable', formData, {
                                            headers: { 'Content-Type': 'multipart/form-data' }

                                        }).then(response => {
                                            $('#cerrar_modal_sua').trigger('click');
                                            /*Validamos la pregunta a la que se realizo el anexo de evidencia*/
                                            if (response.status == 200) {
                                                Swal.fire({
                                                    'icon': "success",
                                                    'title': 'Servicio de RPBI',
                                                    'text': 'Se adjuntó el archivo de forma correcta.'
                                                }).then(function () {
                                                    window.location.reload();
                                                });
                                                $('#customFile').removeClass('is-valid');
                                                $('#comentarios_entregable').removeClass('is-valid');
                                                $('#tipo_entregable').removeClass('is-valid');
                                            }
                                            axios.get("/residuos/getEntregables/" + model.id).then(success => {
                                                if (success.data == null || success.data == "") {
                                                    $('#tEntregables').html(success.data);
                                                }
                                                $('#tEntregables').html(success.data);
                                            });
                                        }).catch(error => {
                                            Swal.fire({
                                                'icon': "error",
                                                'title': 'Servicio de RPBI',
                                                'text': 'Se presento un error al intentar adjuntar el archivo.'
                                            });
                                        });

                                        document.getElementById('customFile').value = '';
                                        $('#file_id').val("");
                                        $(".custom-file-label").text("Seleccionar Archivo");
                                        $('#tipo_entregable').val('');
                                        $('#comentarios_entregable').val('');
                                    } else {
                                        Swal.fire({
                                            'icon': "error",
                                            'title': 'Servicio de RPBI',
                                            'text': 'Ya fue enviado un entregable con el mismo tipo.'
                                        });
                                    }
                                }).catch(e => {
                                    Swal.fire({
                                        'icon': "error",
                                        'title': 'Servicio de RPBI',
                                        'text': 'Ocurrío un error al válidar el entregable.'
                                    });
                                });
                            }
                        }
                    });

                /*FIN Adjunta Entregables*/

                /* Listado de Entregables de la Cedula */
                    axios.get("/residuos/getEntregables/"+model.id).then(response => {
                        if (response.data == null || response.data == "") {
                            $('#tEntregables').html(response.data);
                        }
                        $('#tEntregables').html(response.data);
                    });
                /* Fin Listado de Entregables de la Cedula*/

                /*Editar Entregables*/
                    $(document).on("click", ".update_files", function () {
                        $('#modal_evidencias').modal('show');
                        var id = $(this).data('id');
                        var tipo = $(this).data('tipo');
                        var coments = $(this).data('coments');
                        var file = $(this).data('file');
                        $('#file_id').val(parseInt(id));
                        $(".custom-file-label").text(file);
                        $('#tipo_entregable').val(tipo);
                        $('#comentarios_entregable').val(coments);
                        $('#tipo_entregable').prop('disabled', true);
                        $('#modal_evidencias').modal('show');
                    });
                /*FIN de editar Entregables*/

                /*Elimina entregables*/
                    $(document).on("click", ".delete_files", function () {
                        let id = $(this).data('id');
                        let tipo = $(this).data('tipo');
                        Swal.fire({
                            'icon': 'warning',
                            'title': 'Servicio de RPBI',
                            'text': '¿Estás seguro de eliminar el archivo relacionado a "'+tipo+'"?',
                            'confirmButtonColor': '#3085d6',
                            'cancelButtonColor': '#d33',
                            'confirmButtonText': 'Si, Eliminar Archivo',
                            'cancelButtonText': 'Cancelar',
                            'showCancelButton': true
                        }).then(response => {
                            if (response.isConfirmed) {
                                axios.post("/residuos/eliminaArchivo", { Id: id }).then(response => {
                                    if (response.status == 200) {
                                        Swal.fire(
                                            'Archivo Borrado',
                                            'Tu archivo fue eliminado con éxito.',
                                            'success'
                                        );
                                        axios.get("/residuos/getEntregables/" + model.id).then(response => {
                                            if (response.data == null || response.data == "") {
                                                $('#tEntregables').html(response.data);
                                            }
                                            $('#tEntregables').html(response.data);
                                        });
                                    }
                                }).catch(error => {
                                    Swal.fire(
                                        'Algo Falló',
                                        'No se pudo procesar tu solicitud. Contacta a tu Administrador.',
                                        'error'
                                    );
                                });
                            }
                        });
                    });
                /*FIN de elimina entregables*/

                /*Validaciones Entregables*/
                    $('#tipo_entregable').change(function () {
                        if ($('#tipo_entregable').val() == "") {
                            $('#tipo_entregable').addClass('is-invalid');
                            $('#error_tipoEntre').css('display', 'block');

                            return false;
                        } else {
                            $('#tipo_entregable').removeClass('is-invalid');
                            $('#tipo_entregable').addClass('is-valid');
                            $('#error_tipoEntre').css('display', 'none');
                        }
                    });

                    $('#customFile').change(function () {
                         if ($('#customFile').val() == "") {
                             $('#customFile').addClass('is-invalid');
                             $('#error_customFile').css('display', 'block');

                        } else {
                             var fileName = $("#customFile").val().split("\\").pop();
                             var ext = fileName.split('.').pop();
                             if (ext != "pdf") {
                                 $('#customFile').addClass('is-invalid');
                                 $('#error_customFile').css('display', 'block');
                             } else {
                                 $('#customFile').removeClass('is-invalid');
                                 $('#customFile').addClass('is-valid');
                                 $('#error_customFile').css('display', 'none');
                             }
                        }
                     });

                    $('#comentarios_entregable').change(function () {
                        if ($('#comentarios_entregable').val() == "") {
                            $('#comentarios_entregable').addClass('is-invalid');
                            $('#error_comentariosEntre').css('display', 'block');

                            return false;
                        } else {
                            $('#comentarios_entregable').removeClass('is-invalid');
                            $('#comentarios_entregable').addClass('is-valid');
                            $('#error_comentariosEntre').css('display', 'none');
                        }
                    });
                /*FIN de Validaciones Entregables*/

            /************************************ FIN CARGA/EDICION ARCHIVOS ************************************/
        });
    </script>
}


