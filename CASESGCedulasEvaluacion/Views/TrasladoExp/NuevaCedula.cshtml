@model CedulasEvaluacion.Entities.TrasladoExp.TrasladoExpedientes;
@{
    ViewData["Title"] = "Traslado y Maniobras para el Traslado de Expedientes";
}
<div class="container-fluid" id="limpieza">
    <div class="card">
        <div class="card-header bg-joke text-white">
            <h5 class="mt-2">Generar Cédula</h5>
        </div>
        <div class="card-body">
            <div class="row col-lg-12">
                <div class="col-lg-4">
                    <label for="">Año:</label>
                    <select class="form-control" asp-for="@Model.Anio" id="select_anio" required>
                        <option value="">Seleccione el Año</option>
                        <option value="@System.DateTime.Now.Year">@System.DateTime.Now.Year</option>
                    </select>
                </div>
                <div class=" col-lg-4">
                    <label for="">Mes:</label>
                    <select class="form-control" asp-for="@Model.Mes" id="select_mes" required disabled="true"></select>
                </div>
                <div class=" col-lg-4">
                    <label for="">Área que Evalúa:</label>
                    <select class="form-control" asp-for="@Model.AreaEvaluada" id="select_area" required disabled="true"></select>
                </div>
            </div>
            <div class="row col-lg-12 mt-3">
                <div class="form-check-inline i-checks mt-3">
                    <strong class="text-black mr-3">Maniobras</strong>
                    <input class="levantamiento" type="checkbox" data-toggle="toggle" data-on="<i class='fa fa-check'></i>" data-off="<i class='fa fa-times'></i>"
                           data-onstyle="success" data-offstyle="danger" data-style="ios" value="1">
                </div>
                <div class="form-check-inline i-checks mt-3">
                    <strong class="text-black mr-3">Levantamiento de Inventario</strong>
                    <input class="maniobras" type="checkbox" data-toggle="toggle" data-on="<i class='fa fa-check'></i>" data-off="<i class='fa fa-times'></i>"
                           data-onstyle="success" data-offstyle="danger" data-style="ios" value="1">
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class=" col-lg-12">
                <a href="/home" class="btn btn-danger float-right ml-2">Cancelar</a>
                <button type="submit" class="btn btn-success float-right" id="verificarPeriodo">Generar Cédula</button>
            </div>
        </div>
    </div>
</div>

<style>
    .toggle.ios, .toggle-on.ios, .toggle-off.ios {
        border-radius: 20rem;
    }

        .toggle.ios .toggle-handle {
            border-radius: 20rem;
        }
</style>

@section Scripts{
    <script>
        window.onload = function () {
            var meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            var facturas = new Array();

            $('[data-toggle="tooltip"]').tooltip();

            $("#select_anio").change(function () {
                let optionsMes = "<option value=''>Seleccione el Mes</option>";
                $('#select_mes').prop("disabled", false);
                meses.forEach(function (mes) {
                    optionsMes += "<option value=" + mes + ">" + mes + "</option>"
                });
                $("#select_mes").html(optionsMes);
                changeInput = true;
            });

            /************* Llenamos el Combo de inmuebles *************/
            $("#select_mes").change(function () {
                let optionsarea = "<option value=''>Seleccione el Área</option>";
                $('#select_area').prop("disabled", false);
                optionsarea += "<option value='Dirección General de Archivo y Documentación'>Dirección General de Archivo y Documentación</option>"
                $("#select_area").html(optionsarea);
                changeInput = true;
            });
            /*********** Fin del llenado del combo inmuebles *********/


            /**************** Validación/Guardado al generar el folio ******************/
            $('#verificarPeriodo').click(function (event) {
                event.preventDefault();
                var isContinue = validaFormulario();
                var area = $('#select_area').val();
                var anio = $('#select_anio').val();
                var mes = $('#select_mes').val();
                var levantamiento = $('.levantamiento').prop('checked');
                var maniobras = $('.maniobras').prop('checked');

                if (levantamiento == true) {
                    levantamiento = 1;
                } else {
                    levantamiento = 0;
                }

                if (maniobras == true) {
                    maniobras = 1;
                } else {
                    maniobras = 0;
                }


                if (isContinue == true) {
                    axios.get('/trasladoExp/validaPeriodo/' + anio + '/' + mes).then(response => {
                        if (response.status == 200 && response.data == 0) {
                            axios.post('/trasladoExp/new', {
                                Levantamiento: levantamiento, Anio: parseInt(anio), Mes: mes, Maniobras: maniobras, AreaEvaluada: area
                            }).then(res => {
                                Swal.fire({
                                    'icon': 'success',
                                    'title': 'Traslado y Maniobras de Expedientes',
                                    'text': 'La cédula fue generada de forma correcta.'
                                }).then(function () {
                                    window.location.href = '/trasladoExp/evaluacion/' + res.data;
                                });
                            });
                        } else {
                            Swal.fire({
                                'icon': 'error',
                                'title': 'Traslado y Maniobras de Expedientes',
                                'html': 'Ya fue generada una cédula para el inmueble <strong>' + $('#select_inmueble option:selected').html() + '</strong> para ' +
                                    '<strong>' + $('#select_mes option:selected').html() + '</strong> <strong>' + $('#select_anio option:selected').html() + '</strong>',
                                'confirmButtonColor': '#3085d6',
                                'cancelButtonColor': '#d33',
                                'confirmButtonText': 'Ir a la cédula',
                                'cancelButtonText': 'Cancelar y corregir',
                                'showCancelButton': true,
                            }).then(res => {
                                if (res.isConfirmed) {
                                    window.location.href = '/traslado/evaluacion/' + response.data;
                                }
                            });
                        }
                    }).catch(error => {
                        Swal.fire({
                            'icon': 'error',
                            'title': 'Traslado y Maniobras de Expedientes',
                            'text': 'Error al generar la cédula de mensajería'
                        });
                    });
                }
            });

            function validaFormulario() {
                var anio = $('#select_anio').val();
                var inmueble = $('#select_inmueble').val();
                var mes = $('#select_mes').val();

                if (anio == "") {
                    Swal.fire({
                        'icon': "error",
                        'title': 'Traslado y Maniobras de Expedientes',
                        'html': 'Por favor seleccione el año correspondiente.'

                    });

                    return false;
                }

                if (inmueble == "") {
                    Swal.fire({
                        'icon': "error",
                        'title': 'Traslado y Maniobras de Expedientes',
                        'html': 'Por favor seleccione el inmueble correspondiente.'
                    });

                    return false;
                }

                if (mes == "") {
                    Swal.fire({
                        'icon': "error",
                        'title': 'Traslado y Maniobras de Expedientes',
                        'html': 'Por favor seleccione el mes correspondiente.'
                    });

                    return false;
                }

                return true;
            }



            /*************** Fin de Validación/Guardado al generar el folio ************/

        }
    </script>
}

